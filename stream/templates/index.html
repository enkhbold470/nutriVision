{% extends "base.html" %}

{% block title %}NutriVision - Food Scanner{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-lg-8">
        <header class="text-center mb-5">
            <h1 class="display-4">NutriVision</h1>
            <p class="lead text-muted">Scan your food for instant nutrition information</p>
        </header>

        <div class="video-container mb-4">
            <img src="{{ url_for('video_feed') }}" alt="Video Feed" class="w-100 h-100">
        </div>

        <div class="text-center mb-4">
            <button onclick="capture()" class="btn btn-primary btn-lg" id="captureBtn">
                <i class="bi bi-camera"></i> Capture & Analyze
            </button>
        </div>

        <div class="loading" id="loadingIndicator">
            Analyzing your food...
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <div class="result-container" id="result">
            <div class="text-center text-muted">
                Nutrition information will appear here
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function capture() {
    const captureBtn = document.getElementById('captureBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const resultDiv = document.getElementById('result');
    
    captureBtn.disabled = true;
    loadingIndicator.style.display = 'block';
    resultDiv.innerHTML = '<div class="text-center text-muted">Processing...</div>';
    
    try {
        const response = await fetch('/capture');
        const data = await response.json();
        
        if (data.exceeded_quota) {
            checkQuota(data);
        }
        
        if (data.error) {
            showError(data.error);
            resultDiv.innerHTML = '<div class="text-center text-muted">Error analyzing image</div>';
        } else {
            showSuccess('Food analyzed successfully!');
            resultDiv.innerHTML = formatNutritionData(data);
        }
    } catch (err) {
        showError('Error: ' + err.message);
        resultDiv.innerHTML = '<div class="text-center text-muted">Error analyzing image</div>';
    } finally {
        loadingIndicator.style.display = 'none';
        captureBtn.disabled = false;
    }
}

function formatNutritionData(data) {
    return `
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">${data.name}</h5>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Calories:</span>
                                <strong>${data.nutrition.total_cal} kcal</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Protein:</span>
                                <strong>${data.nutrition.protein}g</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Carbs:</span>
                                <strong>${data.nutrition.total_carbs}g</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Fat:</span>
                                <strong>${data.nutrition.total_fat}g</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Potassium:</span>
                                <strong>${data.nutrition.potassium}mg</strong>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    setTimeout(() => {
        errorDiv.style.display = 'none';
    }, 5000);
}

function showSuccess(message) {
    const successDiv = document.getElementById('successMessage');
    successDiv.textContent = message;
    successDiv.style.display = 'block';
    setTimeout(() => {
        successDiv.style.display = 'none';
    }, 5000);
}
</script>
{% endblock %}
